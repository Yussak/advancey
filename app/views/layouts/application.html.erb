<!DOCTYPE html>
<html>

<head>
  <title><%= full_title(yield(:title)) %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
  <%= stylesheet_pack_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>

  <%= favicon_link_tag('favicon.ico') %>

  <%# 無限スクロール %>
  <%# jscroll %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jscroll/2.4.1/jquery.jscroll.min.js"></script>

  <%# drawer.js %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/css/drawer.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.2.0/iscroll.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.2/js/drawer.min.js"></script>


  <%# ツイッターアイコン %>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.min.js"></script>
<![endif]-->
</head>

<body>
  <%# 投稿ボタンのモーダル  %>
  <div class="modal fade" id="post_create_modal" tabindex="-1" aria-labelledby="post_create_modal_Label"
    aria-hidden="true"></div>
  <%= render 'layouts/header' %>
  <div class="main">
    <% if logged_in? %>
    <div class="drawer drawer--right drawer-close sp-only">
      <button type="button" id="drawer-menu-button" class="drawer-toggle drawer-hamburger position-fixed">
        <span class="drawer-hamburger-icon"></span>
      </button>
      <nav class="drawer-nav">
        <ul class="drawer-menu">
          <%= render 'layouts/links' %>
        </ul>
      </nav>
    </div>
    <% end %>
    <div id="flash_message" class="flash-fixed">
      <%= render 'layouts/flash' %>
    </div>
    <% if logged_in? %>
    <div class="sp-only sp-post-button">
      <%= link_to new_post_path, remote: true, class: "btn btn-primary" do %>
      <i class="fas fa-plus"></i>
      <% end %>
    </div>
    <% end %>
    <%# 他のhtml.erb読み込み↓ %>
    <%= yield %> <%= debug(params) if Rails.env.development? %>
  </div>
</body>

</html>

<style>
  .posts {
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
  }

  .posts li {
    width: 30%;
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
  }

  /* 投稿中身 */
  .post_content {
    text-align: left;
    padding: 10px;
  }

  /* 投稿ボタン部分 */
  .post_button_area {
    display: flex;
    background: aliceblue;
  }

  .main {
    width: 100%;
    margin: 0 auto;

    @media (max-width: 767px) {
      width: 90%;
    }
  }

  header {
    height: 80px;
  }

  .post_user_info {
    display: flex;
  }

  .post_user_info .timestamp {
    padding-left: 15px;
  }

  .feed_area {
    /* background: none; */
    max-width: 1500px;
    margin: 0 auto;
  }
</style>

<script>
  // タブ一覧 スクロールで固定
  var nav_pos = $(".nav").offset().top; //画面上から.nav上端までの距離
  var nav_height = $(".nav").outerHeight(); //.nav+paddingの高さ
  $(window).scroll(function () {
    if ($(this).scrollTop() > nav_pos) {
      $(".nav").addClass("fixed");
    } else {
      $(".nav").removeClass("fixed");
    }
  });

  // 無限スクロール タブ切り替え時だけ動く（リロードでは動かない
  // TOP以外選択でリロードしたら動くように見えてるけどタブは一旦「全部投稿」選択してから自動で前のタブ選択してるのでそこでタブ切り替えが実行されてる。なのでリロードで動いてるように見えてタブ切り替えのおかげだと思う
  // $(document).on('turbolinks:load', function () { // 消しても他のタブでは読み込めるのでこれ効いてない←-all単体でリロード発火は効いてる
  $("a[data-bs-toggle='pill']").on('shown.bs.tab', function (e) {
    var target = $(e.target).attr("href");
    if ((target == '#pills-all')) {
      $('.jscroll-all').jscroll({
        contentSelector: '.jscroll-all',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    } else if ((target == '#pills-mine')) {
      $('.jscroll-mine').jscroll({
        contentSelector: '.jscroll-mine',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    } else if ((target == '#pills-want')) {
      $('.jscroll-want').jscroll({
        contentSelector: '.jscroll-want',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    } else if ((target == '#pills-doing')) {
      $('.jscroll-doing').jscroll({
        contentSelector: '.jscroll-doing',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    } else if ((target == '#pills-master')) {
      $('.jscroll-master').jscroll({
        contentSelector: '.jscroll-master',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    } else if ((target == '#pills-like')) {
      $('.jscroll-like').jscroll({
        contentSelector: '.jscroll-like',
        nextSelector: 'li a[rel="next"]',
        loadingHtml: '読み込み中'
      });
    }
  });
  // });

  // 投稿タブ リロードしても維持
  $(document).on('turbolinks:load', function () {
    $("a[data-bs-toggle='pill']").on('click', function (e) {
      localStorage.setItem('activeTab', $(e.target).attr('href'));
    });
    var activeTab = localStorage.getItem('activeTab');
    if (activeTab) {
      $('#pills-tab a[href="' + activeTab + '"]').tab('show');
    }
  });

  // SP時ドロワー
  $(document).ready(function () {
    $('.drawer').drawer();
  });

  // ブラウザバック禁止
  // history.pushState(null, null, location.href);
  // $(window).on('popstate', function () {
  //   history.go(1);
  // });
</script>